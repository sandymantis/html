class DataTable extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open' });
    this._data = [];
    this._filteredData = [];
    this._sortColumn = null;
    this._sortDirection = 'asc';
    this.render(); // Initial render
  }

  // Define observed attributes
  static get observedAttributes() {
    return ['data'];
  }

  // Getter for data property
  get data() {
    return this._data;
  }

  // Setter for data property
  set data(newData) {
    if (Array.isArray(newData)) {
      this._data = [...newData];
      this._filteredData = [...newData];
      this.setAttribute('data', JSON.stringify(newData));
      this.render();
    }
  }

  // Handle attribute changes
  attributeChangedCallback(name, oldValue, newValue) {
    if (name === 'data' && oldValue !== newValue) {
      try {
        const parsedData = JSON.parse(newValue);
        if (Array.isArray(parsedData)) {
          this._data = parsedData;
          this._filteredData = [...parsedData];
          this.render();
        }
      } catch (e) {
        console.error('Invalid data provided to data-table');
      }
    }
  }

  connectedCallback() {
    this.addEventListeners();
  }

  addEventListeners() {
    // We need to bind the event listeners after each render
    const bindEvents = () => {
      // Filter input handler
      const filterInput = this.shadowRoot.querySelector('.filter-input');
      if (filterInput) {
        filterInput.addEventListener('input', (e) => {
          const filterValue = e.target.value.toLowerCase();
          this._filteredData = this._data.filter(row => 
            Object.values(row).some(value => 
              String(value).toLowerCase().includes(filterValue)
            )
          );
          this.render();
        });
      }

      // Sort handler for column headers
      const table = this.shadowRoot.querySelector('table');
      if (table) {
        table.addEventListener('click', (e) => {
          const headerCell = e.target.closest('th');
          if (headerCell) {
            const column = headerCell.dataset.column;
            this.sortByColumn(column);
          }
        });
      }
    };

    // Initial binding
    bindEvents();

    // Store the bindEvents function for use after renders
    this._bindEvents = bindEvents;
  }

  sortByColumn(column) {
    if (this._sortColumn === column) {
      this._sortDirection = this._sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this._sortColumn = column;
      this._sortDirection = 'asc';
    }

    this._filteredData.sort((a, b) => {
      const valueA = a[column];
      const valueB = b[column];
      
      if (typeof valueA === 'string') {
        return this._sortDirection === 'asc' 
          ? valueA.localeCompare(valueB)
          : valueB.localeCompare(valueA);
      }
      
      return this._sortDirection === 'asc' 
        ? valueA - valueB
        : valueB - valueA;
    });

    this.render();
  }

  getStatusClass(status) {
    const statusMap = {
      'Success': 'success',
      'Failed': 'failed',
      'Processing': 'processing'
    };
    return statusMap[status] || '';
  }

  render() {
    const style = `
      <style>
        :host {
          display: block;
          font-family: system-ui, -apple-system, sans-serif;
        }
        
        .container {
          border: 1px solid #e2e8f0;
          border-radius: 8px;
          padding: 16px;
        }

        .header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 16px;
        }

        .filter-input {
          padding: 8px 12px;
          border: 1px solid #e2e8f0;
          border-radius: 6px;
          width: 200px;
        }

        table {
          width: 100%;
          border-collapse: collapse;
        }

        th, td {
          padding: 12px;
          text-align: left;
          border-bottom: 1px solid #e2e8f0;
        }

        th {
          cursor: pointer;
          user-select: none;
        }

        th:hover {
          background-color: #f8fafc;
        }

        .status-cell {
          display: flex;
          align-items: center;
          gap: 8px;
        }

        .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
        }

        .success .status-indicator {
          background-color: #22c55e;
        }

        .failed .status-indicator {
          background-color: #ef4444;
        }

        .processing .status-indicator {
          background-color: #3b82f6;
        }

        .amount {
          font-family: monospace;
        }

        .footer {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 16px;
          font-size: 14px;
          color: #64748b;
        }

        .sort-indicator::after {
          content: '↕';
          margin-left: 4px;
          opacity: 0.5;
        }

        .sort-asc::after {
          content: '↑';
          opacity: 1;
        }

        .sort-desc::after {
          content: '↓';
          opacity: 1;
        }
      </style>
    `;

    const getSortIndicatorClass = (column) => {
      if (this._sortColumn === column) {
        return this._sortDirection === 'asc' ? 'sort-asc' : 'sort-desc';
      }
      return 'sort-indicator';
    };

    const html = `
      <div class="container">
        <div class="header">
          <input type="text" class="filter-input" placeholder="Filter items...">
        </div>
        
        <table>
          <thead>
            <tr>
              <th data-column="status" class="${getSortIndicatorClass('status')}">Status</th>
              <th data-column="email" class="${getSortIndicatorClass('email')}">Email</th>
              <th data-column="amount" class="${getSortIndicatorClass('amount')}">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${this._filteredData.map(row => `
              <tr>
                <td>
                  <div class="status-cell ${this.getStatusClass(row.status)}">
                    <span class="status-indicator"></span>
                    ${row.status}
                  </div>
                </td>
                <td>${row.email}</td>
                <td class="amount">$${parseFloat(row.amount).toFixed(2)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
        
        <div class="footer">
          <span>${this._filteredData.length} of ${this._data.length} row(s)</span>
        </div>
      </div>
    `;

    this.shadowRoot.innerHTML = style + html;

    // Rebind events after rendering
    if (this._bindEvents) {
      this._bindEvents();
    }
  }
}

// Register the web component
customElements.define('data-table', DataTable);
