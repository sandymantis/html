<style>
  :host {
    display: block;
    font-family: system-ui, -apple-system, sans-serif;
  }
.action-menu {
  position: absolute;
  z-index: 50;
  min-width: 200px;
  background-color: white;
  border: 1px solid #e5e7eb;
  border-radius: 0.375rem;
  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}

.action-menu-content {
  padding: 0.5rem;
}

.action-menu-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.5rem;
  text-align: left;
  border: none;
  background: none;
  border-radius: 0.25rem;
  font-size: 0.875rem;
  color: #374151;
  cursor: pointer;
}

.action-menu-item:hover {
  background-color: #f3f4f6;
}

.action-menu-divider {
  margin: 0.5rem 0;
  border: 0;
  border-top: 1px solid #e5e7eb;
}

.action-menu .icon {
  width: 1rem;
  height: 1rem;
}
  .table-container {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .table-header {
    padding: 1rem;
    border-bottom: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .table-title {
    font-size: 1.125rem;
    font-weight: 500;
    color: #111827;
  }

  .table-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
  }

  .page-size-select {
    padding: 0.375rem 2rem 0.375rem 0.75rem;
    border: 1px solid #e5e7eb;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #374151;
    background-color: white;
    cursor: pointer;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th, td {
    padding: 0.75rem 1rem;
    text-align: left;
  }

  th {
    background-color: #f9fafb;
    font-weight: 500;
    color: #6b7280;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    position: sticky;
    top: 0;
    z-index: 10;
  }

  th.sortable {
    cursor: pointer;
    user-select: none;
  }

  th.sortable:hover {
    background-color: #f3f4f6;
  }

  tr:not(:last-child) td {
    border-bottom: 1px solid #e5e7eb;
  }

  tr:hover td {
    background-color: #f9fafb;
  }

  .checkbox-cell {
    width: 48px;
    padding-right: 0;
  }

  input[type="checkbox"] {
    border-radius: 0.25rem;
    border: 1px solid #d1d5db;
    width: 1rem;
    height: 1rem;
    cursor: pointer;
  }

  .member-cell {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .member-avatar {
    width: 2rem;
    height: 2rem;
    background-color: #f3f4f6;
    border-radius: 9999px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 500;
    color: #4b5563;
    font-size: 0.875rem;
  }

  .member-info {
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .member-name {
    font-weight: 500;
    color: #111827;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .member-email {
    font-size: 0.875rem;
    color: #6b7280;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .status-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .status-cell.active .icon {
    color: #16a34a;
  }

  .status-cell.inactive .icon {
    color: #dc2626;
  }

  .status-cell.pending .icon {
    color: #ca8a04;
  }

  .status-cell span {
    font-size: 0.875rem;
  }

  .status-cell.active span {
    color: #16a34a;
  }

  .status-cell.inactive span {
    color: #dc2626;
  }

  .status-cell.pending span {
    color: #ca8a04;
  }

  .membership-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .membership-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 500;
  }

  .membership-badge.premium {
    background-color: #fef3c7;
    color: #92400e;
  }

  .membership-badge.basic {
    background-color: #e0e7ff;
    color: #3730a3;
  }

  .membership-badge.trial {
    background-color: #f3e8ff;
    color: #6b21a8;
  }

  .date-cell {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #6b7280;
  }

  .icon {
    flex-shrink: 0;
    width: 1rem;
    height: 1rem;
  }

  .icon.premium {
    color: #92400e;
  }

  .actions-cell {
    display: flex;
    justify-content: flex-end;
  }

  .action-button {
    padding: 0.25rem;
    border: none;
    background: none;
    border-radius: 9999px;
    cursor: pointer;
    color: #6b7280;
  }

  .action-button:hover {
    background-color: #f3f4f6;
    color: #374151;
  }

  .pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
  }

  .pagination-info {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .pagination-controls {
    display: flex;
    gap: 0.5rem;
  }

  .pagination-button {
    padding: 0.5rem 1rem;
    border: 1px solid #e5e7eb;
    background-color: white;
    border-radius: 0.375rem;
    font-size: 0.875rem;
    color: #374151;
    cursor: pointer;
  }

  .pagination-button:hover:not(:disabled) {
    background-color: #f9fafb;
  }

  .pagination-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .table-empty {
    padding: 3rem 1rem;
    text-align: center;
    color: #6b7280;
  }

  .table-scroll {
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
  }

  /* Sort indicators */
  .sort-indicator::after {
    content: '↕';
    margin-left: 0.5rem;
    opacity: 0.5;
  }

  .sort-asc::after {
    content: '↑';
    margin-left: 0.5rem;
    opacity: 1;
  }

  .sort-desc::after {
    content: '↓';
    margin-left: 0.5rem;
    opacity: 1;
  }

  @media (max-width: 768px) {
    .member-cell {
      flex-direction: column;
      align-items: flex-start;
      gap: 0.25rem;
    }

    .date-cell {
      flex-direction: column;
      align-items: flex-start;
    }

    .table-header {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }

    .pagination {
      flex-direction: column;
      gap: 1rem;
      align-items: flex-start;
    }
  }
</style>

class MemberTable extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: 'open' });
    
    // Internal state
    this._data = [];
    this._sortField = 'name';
    this._sortDirection = 'asc';
    this._selectedRows = new Set();
    this._pageSize = 10;
    this._currentPage = 1;
    this._totalPages = 0;

    // Column definitions
    this._columns = [
      {
        id: 'status',
        header: 'Status',
        sortable: true,
        render: (member) => `
          <div class="status-cell ${member.status.toLowerCase()}">
            ${this.getStatusIcon(member.status)}
            <span>${member.status}</span>
          </div>
        `
      },
      {
        id: 'name',
        header: 'Member Name',
        sortable: true,
        render: (member) => `
          <div class="member-cell">
            <div class="member-avatar">
              ${member.name.split(' ').map(n => n[0]).join('')}
            </div>
            <div class="member-info">
              <div class="member-name">${member.name}</div>
              <div class="member-email">${member.email}</div>
            </div>
          </div>
        `
      },
      {
        id: 'membershipType',
        header: 'Membership',
        sortable: true,
        render: (member) => `
          <div class="membership-cell">
            ${member.membershipType === 'Premium' ? this.getPremiumIcon() : ''}
            <span class="membership-badge ${member.membershipType.toLowerCase()}">
              ${member.membershipType}
            </span>
          </div>
        `
      },
      {
        id: 'joinDate',
        header: 'Join Date',
        sortable: true,
        render: (member) => `
          <div class="date-cell">
            ${this.getCalendarIcon()}
            ${new Date(member.joinDate).toLocaleDateString()}
          </div>
        `
      },
      {
        id: 'lastActive',
        header: 'Last Active',
        sortable: true,
        render: (member) => `
          <div class="date-cell">
            ${this.formatLastActive(member.lastActive)}
          </div>
        `
      },
      {
        id: 'actions',
        header: '',
        sortable: false,
        render: (member) => `
          <div class="actions-cell">
            <button class="action-button" data-member-id="${member.id}">
              ${this.getMoreIcon()}
            </button>
          </div>
        `
      }
    ];

    this.render();
  }

  static get observedAttributes() {
    return ['data'];
  }

  attributeChangedCallback(name, oldValue, newValue) {
    if (name === 'data') {
      try {
        this._data = JSON.parse(newValue);
        this._totalPages = Math.ceil(this._data.length / this._pageSize);
        this.render();
      } catch (e) {
        console.error('Invalid data provided to member-table');
      }
    }
  }

  get data() {
    return this._data;
  }

  set data(newData) {
    if (Array.isArray(newData)) {
      this._data = [...newData];
      this._totalPages = Math.ceil(this._data.length / this._pageSize);
      this.setAttribute('data', JSON.stringify(newData));
      this.render();
    }
  }

  handleSort(field) {
    if (field === this._sortField) {
      this._sortDirection = this._sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
      this._sortField = field;
      this._sortDirection = 'asc';
    }
    this.render();
  }

  handleRowSelect(id) {
    if (this._selectedRows.has(id)) {
      this._selectedRows.delete(id);
    } else {
      this._selectedRows.add(id);
    }
    this.render();
  }

  handleSelectAll() {
    if (this._selectedRows.size === this._data.length) {
      this._selectedRows.clear();
    } else {
      this._selectedRows = new Set(this._data.map(row => row.id));
    }
    this.render();
  }

  handlePageChange(direction) {
    if (direction === 'prev' && this._currentPage > 1) {
      this._currentPage--;
    } else if (direction === 'next' && this._currentPage < this._totalPages) {
      this._currentPage++;
    }
    this.render();
  }

  handlePageSizeChange(newSize) {
    this._pageSize = parseInt(newSize);
    this._currentPage = 1;
    this._totalPages = Math.ceil(this._data.length / this._pageSize);
    this.render();
  }

  sortData(data) {
    return [...data].sort((a, b) => {
      if (a[this._sortField] < b[this._sortField]) return this._sortDirection === 'asc' ? -1 : 1;
      if (a[this._sortField] > b[this._sortField]) return this._sortDirection === 'asc' ? 1 : -1;
      return 0;
    });
  }

  getPaginatedData() {
    const sortedData = this.sortData(this._data);
    const start = (this._currentPage - 1) * this._pageSize;
    const end = start + this._pageSize;
    return sortedData.slice(start, end);
  }

  formatLastActive(date) {
    const now = new Date();
    const lastActive = new Date(date);
    const diffTime = Math.abs(now - lastActive);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yesterday';
    if (diffDays < 7) return `${diffDays} days ago`;
    return lastActive.toLocaleDateString();
  }

  connectedCallback() {
    this.addEventListeners();
  }
// Add these methods to the MemberTable class

addEventListeners() {
  const bindEvents = () => {
    // Sort headers
    this.shadowRoot.querySelectorAll('th[data-sortable="true"]').forEach(th => {
      th.addEventListener('click', () => {
        const field = th.dataset.field;
        this.handleSort(field);
        this.dispatchEvent(new CustomEvent('sort', {
          detail: { field, direction: this._sortDirection }
        }));
      });
    });

    // Row selection
    this.shadowRoot.querySelectorAll('.row-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const id = parseInt(e.target.dataset.id);
        this.handleRowSelect(id);
        this.dispatchEvent(new CustomEvent('select', {
          detail: { 
            id, 
            selected: this._selectedRows.has(id),
            selectedRows: Array.from(this._selectedRows)
          }
        }));
      });

      // Row click for selection
      const row = checkbox.closest('tr');
      if (row) {
        row.addEventListener('click', (e) => {
          if (!e.target.closest('button')) { // Don't trigger on button clicks
            const id = parseInt(checkbox.dataset.id);
            this.handleRowSelect(id);
            this.dispatchEvent(new CustomEvent('select', {
              detail: { 
                id, 
                selected: this._selectedRows.has(id),
                selectedRows: Array.from(this._selectedRows)
              }
            }));
          }
        });
      }
    });

    // Select all checkbox
    const selectAll = this.shadowRoot.querySelector('#select-all');
    if (selectAll) {
      selectAll.addEventListener('change', () => {
        this.handleSelectAll();
        this.dispatchEvent(new CustomEvent('selectAll', {
          detail: { 
            selectedRows: Array.from(this._selectedRows)
          }
        }));
      });
    }

    // Pagination controls
    const prevButton = this.shadowRoot.querySelector('.prev-page');
    const nextButton = this.shadowRoot.querySelector('.next-page');
    if (prevButton) {
      prevButton.addEventListener('click', () => {
        this.handlePageChange('prev');
        this.dispatchEvent(new CustomEvent('pageChange', {
          detail: { page: this._currentPage }
        }));
      });
    }
    if (nextButton) {
      nextButton.addEventListener('click', () => {
        this.handlePageChange('next');
        this.dispatchEvent(new CustomEvent('pageChange', {
          detail: { page: this._currentPage }
        }));
      });
    }

    // Page size selector
    const pageSizeSelect = this.shadowRoot.querySelector('.page-size-select');
    if (pageSizeSelect) {
      pageSizeSelect.addEventListener('change', (e) => {
        this.handlePageSizeChange(e.target.value);
        this.dispatchEvent(new CustomEvent('pageSizeChange', {
          detail: { pageSize: this._pageSize }
        }));
      });
    }

    // Action buttons
    this.shadowRoot.querySelectorAll('.action-button').forEach(button => {
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        const memberId = parseInt(button.dataset.memberId);
        const member = this._data.find(m => m.id === memberId);
        if (member) {
          // Show dropdown menu
          const menu = this.createActionMenu(member);
          this.showActionMenu(menu, button);
        }
      });
    });

    // Close action menu when clicking outside
    document.addEventListener('click', (e) => {
      const menu = this.shadowRoot.querySelector('.action-menu');
      if (menu && !menu.contains(e.target)) {
        menu.remove();
      }
    });
  };

  bindEvents();
  this._bindEvents = bindEvents;
}

createActionMenu(member) {
  const menu = document.createElement('div');
  menu.className = 'action-menu';
  menu.innerHTML = `
    <div class="action-menu-content">
      <button class="action-menu-item" data-action="view">
        ${this.getViewIcon()} View Details
      </button>
      <button class="action-menu-item" data-action="edit">
        ${this.getEditIcon()} Edit Member
      </button>
      <button class="action-menu-item" data-action="email">
        ${this.getEmailIcon()} Send Email
      </button>
      <hr class="action-menu-divider">
      <button class="action-menu-item text-red-600" data-action="delete">
        ${this.getDeleteIcon()} Remove Member
      </button>
    </div>
  `;

  // Add event listeners to menu items
  menu.querySelectorAll('.action-menu-item').forEach(item => {
    item.addEventListener('click', (e) => {
      const action = e.currentTarget.dataset.action;
      this.dispatchEvent(new CustomEvent('action', {
        detail: { action, member }
      }));
      menu.remove();
    });
  });

  return menu;
}

showActionMenu(menu, button) {
  // Remove any existing menus
  this.shadowRoot.querySelectorAll('.action-menu').forEach(m => m.remove());

  // Position the menu
  const rect = button.getBoundingClientRect();
  menu.style.position = 'absolute';
  menu.style.top = `${rect.bottom + window.scrollY + 5}px`;
  menu.style.right = `${window.innerWidth - rect.right}px`;
  
  this.shadowRoot.appendChild(menu);
}

// Helper method to get icon SVGs
getViewIcon() {
  return `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
    <path d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
  </svg>`;
}

getEditIcon() {
  return `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/>
  </svg>`;
}

getEmailIcon() {
  return `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
  </svg>`;
}

getDeleteIcon() {
  return `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
  </svg>`;
}

render() {
  const template = `
    ${styles}
    <div class="table-container">
      <div class="table-header">
        <div class="table-title">
          Members (${this._data.length})
        </div>
        <div class="table-controls">
          <select class="page-size-select">
            <option value="10" ${this._pageSize === 10 ? 'selected' : ''}>10 per page</option>
            <option value="25" ${this._pageSize === 25 ? 'selected' : ''}>25 per page</option>
            <option value="50" ${this._pageSize === 50 ? 'selected' : ''}>50 per page</option>
          </select>
        </div>
      </div>

      <div class="table-scroll">
        ${this._data.length === 0 ? `
          <div class="table-empty">
            No members found
          </div>
        ` : `
          <table>
            <thead>
              <tr>
                <th class="checkbox-cell">
                  <input 
                    type="checkbox" 
                    id="select-all"
                    ${this._selectedRows.size === this._data.length ? 'checked' : ''}
                  >
                </th>
                ${this._columns.map(column => `
                  <th 
                    class="${column.sortable ? 'sortable' : ''} 
                           ${this._sortField === column.id ? 
                             this._sortDirection === 'asc' ? 'sort-asc' : 'sort-desc' 
                             : column.sortable ? 'sort-indicator' : ''}"
                    data-field="${column.id}"
                    data-sortable="${column.sortable}"
                  >
                    ${column.header}
                  </th>
                `).join('')}
              </tr>
            </thead>
            <tbody>
              ${this.getPaginatedData().map(member => `
                <tr class="member-row" data-id="${member.id}">
                  <td class="checkbox-cell">
                    <input 
                      type="checkbox" 
                      class="row-checkbox"
                      data-id="${member.id}"
                      ${this._selectedRows.has(member.id) ? 'checked' : ''}
                    >
                  </td>
                  ${this._columns.map(column => `
                    <td>${column.render(member)}</td>
                  `).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        `}
      </div>

      ${this._data.length > 0 ? `
        <div class="pagination">
          <div class="pagination-info">
            Showing ${((this._currentPage - 1) * this._pageSize) + 1} to 
            ${Math.min(this._currentPage * this._pageSize, this._data.length)} of 
            ${this._data.length} results
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-button prev-page" 
              ${this._currentPage === 1 ? 'disabled' : ''}
            >
              Previous
            </button>
            <button 
              class="pagination-button next-page"
              ${this._currentPage === this._totalPages ? 'disabled' : ''}
            >
              Next
            </button>
          </div>
        </div>
      ` : ''}
    </div>
  `;

  this.shadowRoot.innerHTML = template;
  
  // After rendering, bind all event listeners
  if (this._bindEvents) {
    this._bindEvents();
  }
}

// Helper methods for icons (used in column definitions)
getStatusIcon(status) {
  return {
    'Active': `
      <svg class="icon success" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20 6L9 17L4 12"></path>
      </svg>
    `,
    'Inactive': `
      <svg class="icon error" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12"></path>
      </svg>
    `,
    'Pending': `
      <svg class="icon warning" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
    `
  }[status] || '';
}

getCalendarIcon() {
  return `
    <svg class="icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
  `;
}

getPremiumIcon() {
  return `
    <svg class="icon premium" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
    </svg>
  `;
}

getMoreIcon() {
  return `
    <svg class="icon" viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="1"></circle>
      <circle cx="19" cy="12" r="1"></circle>
      <circle cx="5" cy="12" r="1"></circle>
    </svg>
  `;
}
}

customElements.define('member-table', MemberTable);
